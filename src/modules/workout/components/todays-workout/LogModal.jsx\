// src/modules/workout/components/todays-workout/LogModal.jsx
import { X, CheckCircle, Dumbbell, Check } from 'lucide-react'
import { useState, useEffect } from 'react'
import ExerciseList from './components/ExerciseList'

export default function LogModal({ workout, todaysLogs, onClose, onLogsUpdate, onWorkoutCompleted, client, schema, db }) {
  const isMobile = window.innerWidth <= 768
  const [visible, setVisible] = useState(false)
  const [completedCount, setCompletedCount] = useState(0)
  const [isFinishing, setIsFinishing] = useState(false)
  const [isWorkoutCompleted, setIsWorkoutCompleted] = useState(false)
  
  // Progressive reveal animation
  useEffect(() => {
    setTimeout(() => setVisible(true), 50)
    checkWorkoutCompletion()
  }, [])
  
  // Check if workout is already completed
  const checkWorkoutCompletion = async () => {
    if (!client?.id || !db) return
    
    try {
      const today = new Date().toISOString().split('T')[0]
      const { data } = await db.supabase
        .from('workout_completions')
        .select('completed')
        .eq('client_id', client.id)
        .eq('workout_date', today)
        .single()
      
      setIsWorkoutCompleted(data?.completed || false)
    } catch (error) {
      setIsWorkoutCompleted(false)
    }
  }
  
  // Count completed exercises
  useEffect(() => {
    if (todaysLogs && workout.exercises) {
      const loggedExercises = new Set(todaysLogs.map(log => log.exercise_name))
      const completed = workout.exercises.filter(ex => loggedExercises.has(ex.name)).length
      setCompletedCount(completed)
    }
  }, [todaysLogs, workout.exercises])
  
  // Handle close with animation
  const handleClose = () => {
    setVisible(false)
    setTimeout(() => {
      onClose()
    }, 300)
  }
  
  // ‚≠ê FIXED: Finish Workout + Trigger parent refresh
  const handleFinishWorkout = async () => {
    if (!client?.id || !db) return
    
    setIsFinishing(true)
    
    try {
      const today = new Date().toISOString().split('T')[0]
      
      // Save to database
      const { error } = await db.supabase
        .from('workout_completions')
        .upsert({
          client_id: client.id,
          workout_date: today,
          completed: true
        }, {
          onConflict: 'client_id,workout_date'
        })
      
      if (error) throw error
      
      console.log('‚úÖ Workout marked as completed')
      
      // Success feedback
      if (navigator.vibrate) navigator.vibrate([50, 100, 50, 100, 50])
      
      setIsWorkoutCompleted(true)
      
      // ‚≠ê NIEUW: Trigger parent refresh voor challenge banner
      if (onWorkoutCompleted) {
        console.log('üîî Triggering parent refresh for challenge banner')
        onWorkoutCompleted()
      }
      
      // Close modal after 1 second
      setTimeout(() => {
        handleClose()
      }, 1000)
      
    } catch (error) {
      console.error('‚ùå Error finishing workout:', error)
      alert('Er ging iets mis bij het voltooien. Probeer opnieuw.')
      setIsFinishing(false)
    }
  }
  
  // Prevent body scroll when modal open
  useEffect(() => {
    document.body.style.overflow = 'hidden'
    return () => {
      document.body.style.overflow = 'auto'
    }
  }, [])
  
  // Handle escape key
  useEffect(() => {
    const handleEscape = (e) => {
      if (e.key === 'Escape') handleClose()
    }
    window.addEventListener('keydown', handleEscape)
    return () => window.removeEventListener('keydown', handleEscape)
  }, [])
  
  const totalExercises = workout.exercises?.length || 0
  const progressPercentage = totalExercises > 0 ? (completedCount / totalExercises) * 100 : 0
  
  return (
    <div
      style={{
        position: 'fixed',
        inset: 0,
        background: 'rgba(0, 0, 0, 0.95)',
        backdropFilter: 'blur(20px)',
        zIndex: 1000,
        display: 'flex',
        flexDirection: 'column',
        opacity: visible ? 1 : 0,
        transition: 'opacity 0.3s ease-out'
      }}
      onClick={(e) => {
        if (e.target === e.currentTarget) handleClose()
      }}
    >
      {/* Header */}
      <div style={{
        background: 'linear-gradient(135deg, rgba(17, 17, 17, 0.98) 0%, rgba(10, 10, 10, 0.98) 100%)',
        backdropFilter: 'blur(20px)',
        borderBottom: '1px solid rgba(249, 115, 22, 0.25)',
        padding: isMobile ? '0.875rem 1rem' : '1.25rem 1.5rem',
        position: 'sticky',
        top: 0,
        zIndex: 10,
        boxShadow: '0 4px 20px rgba(0, 0, 0, 0.5), 0 0 60px rgba(249, 115, 22, 0.1)'
      }}>
        {/* Top glow accent */}
        <div style={{
          position: 'absolute',
          top: 0,
          left: 0,
          right: 0,
          height: '2px',
          background: 'linear-gradient(90deg, transparent 0%, #f97316 50%, transparent 100%)',
          opacity: 0.6
        }} />
        
        <div style={{
          maxWidth: '1200px',
          margin: '0 auto',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center'
        }}>
          {/* Title section */}
          <div style={{ flex: 1, minWidth: 0 }}>
            {/* Badge */}
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: '0.4rem',
              marginBottom: '0.4rem'
            }}>
              <div style={{
                width: isMobile ? '24px' : '28px',
                height: isMobile ? '24px' : '28px',
                borderRadius: '8px',
                background: isWorkoutCompleted 
                  ? 'rgba(16, 185, 129, 0.2)' 
                  : 'rgba(249, 115, 22, 0.2)',
                border: isWorkoutCompleted
                  ? '1px solid rgba(16, 185, 129, 0.3)'
                  : '1px solid rgba(249, 115, 22, 0.3)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                boxShadow: isWorkoutCompleted
                  ? '0 0 15px rgba(16, 185, 129, 0.3)'
                  : '0 0 15px rgba(249, 115, 22, 0.3)'
              }}>
                {isWorkoutCompleted ? (
                  <CheckCircle 
                    size={isMobile ? 12 : 14} 
                    color="#10b981"
                    style={{ filter: 'drop-shadow(0 0 6px rgba(16, 185, 129, 0.6))' }}
                  />
                ) : (
                  <Dumbbell 
                    size={isMobile ? 12 : 14} 
                    color="#f97316"
                    style={{ filter: 'drop-shadow(0 0 6px rgba(249, 115, 22, 0.6))' }}
                  />
                )}
              </div>
              <span style={{
                fontSize: isMobile ? '0.65rem' : '0.7rem',
                color: isWorkoutCompleted ? '#10b981' : '#f97316',
                fontWeight: '700',
                textTransform: 'uppercase',
                letterSpacing: '0.05em'
              }}>
                {isWorkoutCompleted ? 'VOLTOOID' : 'LOG WORKOUT'}
              </span>
            </div>
            
            {/* Title */}
            <h2 style={{
              fontSize: isMobile ? '1.1rem' : '1.3rem',
              fontWeight: '800',
              color: '#fff',
              margin: '0 0 0.625rem 0',
              letterSpacing: '-0.02em',
              overflow: 'hidden',
              textOverflow: 'ellipsis',
              whiteSpace: 'nowrap'
            }}>
              {workout.name}
            </h2>
            
            {/* Progress bar */}
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: '0.625rem'
            }}>
              <div style={{
                flex: 1,
                height: '6px',
                background: 'rgba(0, 0, 0, 0.5)',
                borderRadius: '3px',
                overflow: 'hidden',
                border: '1px solid rgba(249, 115, 22, 0.1)'
              }}>
                <div style={{
                  height: '100%',
                  width: `${progressPercentage}%`,
                  background: progressPercentage >= 90
                    ? 'linear-gradient(90deg, #10b981 0%, #34d399 100%)'
                    : 'linear-gradient(90deg, #f97316 0%, #fb923c 100%)',
                  transition: 'width 0.5s cubic-bezier(0.4, 0, 0.2, 1)',
                  boxShadow: progressPercentage >= 90
                    ? '0 0 15px rgba(16, 185, 129, 0.5)'
                    : progressPercentage > 0 
                      ? '0 0 10px rgba(249, 115, 22, 0.3)'
                      : 'none'
                }} />
              </div>
              
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: '0.3rem',
                fontSize: isMobile ? '0.7rem' : '0.75rem',
                color: progressPercentage >= 90 ? '#10b981' : '#f97316',
                fontWeight: '700',
                minWidth: 'fit-content'
              }}>
                {completedCount > 0 && (
                  <CheckCircle 
                    size={isMobile ? 13 : 14} 
                    style={{
                      filter: progressPercentage >= 90
                        ? 'drop-shadow(0 0 6px rgba(16, 185, 129, 0.6))'
                        : 'drop-shadow(0 0 6px rgba(249, 115, 22, 0.4))'
                    }}
                  />
                )}
                {completedCount}/{totalExercises}
              </div>
            </div>
          </div>
          
          {/* Close button */}
          <button
            onClick={handleClose}
            style={{
              width: '44px',
              height: '44px',
              background: 'rgba(23, 23, 23, 0.6)',
              backdropFilter: 'blur(10px)',
              border: '1px solid rgba(249, 115, 22, 0.2)',
              borderRadius: '10px',
              color: '#f97316',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              cursor: 'pointer',
              transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
              marginLeft: isMobile ? '0.75rem' : '1rem',
              flexShrink: 0,
              touchAction: 'manipulation',
              WebkitTapHighlightColor: 'transparent'
            }}
            onMouseEnter={(e) => {
              if (!isMobile) {
                e.currentTarget.style.background = 'rgba(249, 115, 22, 0.15)'
                e.currentTarget.style.borderColor = 'rgba(249, 115, 22, 0.3)'
                e.currentTarget.style.transform = 'scale(1.05)'
              }
            }}
            onMouseLeave={(e) => {
              if (!isMobile) {
                e.currentTarget.style.background = 'rgba(23, 23, 23, 0.6)'
                e.currentTarget.style.borderColor = 'rgba(249, 115, 22, 0.2)'
                e.currentTarget.style.transform = 'scale(1)'
              }
            }}
            onTouchStart={(e) => {
              if (isMobile) {
                e.currentTarget.style.transform = 'scale(0.95)'
              }
            }}
            onTouchEnd={(e) => {
              if (isMobile) {
                e.currentTarget.style.transform = 'scale(1)'
              }
            }}
          >
            <X size={isMobile ? 18 : 20} strokeWidth={2.5} />
          </button>
        </div>
      </div>
      
      {/* Content - Scrollable */}
      <div style={{
        flex: 1,
        overflow: 'auto',
        padding: isMobile ? '1rem' : '1.5rem 1rem',
        WebkitOverflowScrolling: 'touch'
      }}>
        <div style={{
          maxWidth: '1200px',
          margin: '0 auto'
        }}>
          <ExerciseList
            exercises={workout.exercises || []}
            todaysLogs={todaysLogs}
            onLogsUpdate={onLogsUpdate}
            client={client}
            schema={schema}
            db={db}
            workoutDayKey={workout.dayKey}
          />
        </div>
      </div>
      
      {/* ‚≠ê FOOTER - FINISH WORKOUT KNOP */}
      {!isWorkoutCompleted && (
        <div style={{
          background: 'linear-gradient(135deg, rgba(17, 17, 17, 0.98) 0%, rgba(10, 10, 10, 0.98) 100%)',
          backdropFilter: 'blur(20px)',
          borderTop: '1px solid rgba(249, 115, 22, 0.25)',
          padding: isMobile ? '1rem' : '1.25rem 1.5rem',
          position: 'relative',
          overflow: 'hidden'
        }}>
          {/* Top glow */}
          <div style={{
            position: 'absolute',
            top: 0,
            left: 0,
            right: 0,
            height: '2px',
            background: 'linear-gradient(90deg, transparent 0%, #10b981 50%, transparent 100%)',
            opacity: 0.4
          }} />
          
          <div style={{
            maxWidth: '1200px',
            margin: '0 auto'
          }}>
            {/* Grote groene FINISH knop */}
            <button
              onClick={handleFinishWorkout}
              disabled={isFinishing}
              style={{
                width: '100%',
                background: isFinishing
                  ? 'rgba(16, 185, 129, 0.5)'
                  : 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                border: 'none',
                borderRadius: '12px',
                padding: isMobile ? '1rem' : '1.25rem',
                color: '#000',
                fontSize: isMobile ? '0.95rem' : '1.05rem',
                fontWeight: '800',
                textTransform: 'uppercase',
                letterSpacing: '0.05em',
                cursor: isFinishing ? 'not-allowed' : 'pointer',
                boxShadow: isFinishing
                  ? 'none'
                  : '0 8px 32px rgba(16, 185, 129, 0.4)',
                transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                gap: '0.625rem',
                minHeight: '56px',
                touchAction: 'manipulation',
                WebkitTapHighlightColor: 'transparent',
                opacity: isFinishing ? 0.7 : 1
              }}
              onMouseEnter={(e) => {
                if (!isMobile && !isFinishing) {
                  e.currentTarget.style.transform = 'translateY(-2px)'
                  e.currentTarget.style.boxShadow = '0 12px 40px rgba(16, 185, 129, 0.5)'
                }
              }}
              onMouseLeave={(e) => {
                if (!isMobile && !isFinishing) {
                  e.currentTarget.style.transform = 'translateY(0)'
                  e.currentTarget.style.boxShadow = '0 8px 32px rgba(16, 185, 129, 0.4)'
                }
              }}
              onTouchStart={(e) => {
                if (isMobile && !isFinishing) {
                  e.currentTarget.style.transform = 'scale(0.98)'
                }
              }}
              onTouchEnd={(e) => {
                if (isMobile && !isFinishing) {
                  e.currentTarget.style.transform = 'scale(1)'
                }
              }}
            >
              {isFinishing ? (
                <>
                  <div style={{
                    width: isMobile ? '18px' : '20px',
                    height: isMobile ? '18px' : '20px',
                    border: '3px solid rgba(0, 0, 0, 0.3)',
                    borderTopColor: '#000',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite'
                  }} />
                  Voltooien...
                </>
              ) : (
                <>
                  <Check size={isMobile ? 22 : 24} strokeWidth={3} />
                  Workout Voltooien
                </>
              )}
            </button>
            
            {/* Kleine tekst onder knop */}
            <p style={{
              textAlign: 'center',
              fontSize: isMobile ? '0.65rem' : '0.7rem',
              color: 'rgba(255, 255, 255, 0.4)',
              margin: '0.75rem 0 0 0',
              fontWeight: '600'
            }}>
              Klik hier om je workout als voltooid te markeren
            </p>
          </div>
        </div>
      )}
      
      {/* Success message als workout completed */}
      {isWorkoutCompleted && (
        <div style={{
          background: 'linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.08) 100%)',
          backdropFilter: 'blur(10px)',
          borderTop: '1px solid rgba(16, 185, 129, 0.3)',
          padding: isMobile ? '0.875rem 1rem' : '1.25rem 1.5rem',
          textAlign: 'center',
          animation: 'slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1)',
          position: 'relative',
          overflow: 'hidden'
        }}>
          {/* Top glow */}
          <div style={{
            position: 'absolute',
            top: 0,
            left: 0,
            right: 0,
            height: '2px',
            background: 'linear-gradient(90deg, transparent 0%, #10b981 50%, transparent 100%)',
            opacity: 0.6
          }} />
          
          <div style={{
            maxWidth: '600px',
            margin: '0 auto'
          }}>
            <div style={{
              fontSize: isMobile ? '1.1rem' : '1.3rem',
              fontWeight: '800',
              color: '#10b981',
              marginBottom: '0.35rem',
              letterSpacing: '-0.02em',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: '0.5rem'
            }}>
              <CheckCircle 
                size={isMobile ? 20 : 24} 
                style={{ filter: 'drop-shadow(0 0 10px rgba(16, 185, 129, 0.6))' }}
              />
              WORKOUT VOLTOOID!
            </div>
            <div style={{
              fontSize: isMobile ? '0.75rem' : '0.8rem',
              color: 'rgba(255, 255, 255, 0.7)',
              fontWeight: '600'
            }}>
              {totalExercises > 0 && completedCount === totalExercises
                ? `Geweldig werk! Alle ${totalExercises} oefeningen gelogd.`
                : 'Geweldig werk vandaag! Workout voltooid.'}
            </div>
          </div>
        </div>
      )}
      
      {/* CSS Animations */}
      <style>{`
        @keyframes slideUp {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        
        @keyframes spin {
          to { transform: rotate(360deg); }
        }
        
        /* Custom scrollbar */
        *::-webkit-scrollbar {
          width: 8px;
        }
        
        *::-webkit-scrollbar-track {
          background: rgba(0, 0, 0, 0.3);
        }
        
        *::-webkit-scrollbar-thumb {
          background: rgba(249, 115, 22, 0.3);
          borderRadius: 4px;
        }
        
        *::-webkit-scrollbar-thumb:hover {
          background: rgba(249, 115, 22, 0.5);
        }
      `}</style>
    </div>
  )
}
